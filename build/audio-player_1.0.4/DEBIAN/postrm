#!/bin/bash
set -e

# Function to remove LCD configuration
remove_lcd_config() {
    local config_file="$1"
    
    if [ ! -f "$config_file" ]; then
        return
    fi
    
    echo "Removing LCD configuration from $config_file..."
    
    # Create a temp file for the cleaned config
    TEMP_FILE=$(mktemp)
    
    # Remove audio-player LCD configuration section
    awk '
    BEGIN { in_audio_player_section = 0 }
    /# 3.5" LCD Configuration \(auto-configured by audio-player\)/ { in_audio_player_section = 1; next }
    /^dtoverlay=(tft35a|waveshare35a)/ && in_audio_player_section { next }
    /^#.*|^$/ && in_audio_player_section { next }
    !/^$/ { in_audio_player_section = 0; print }
    ' "$config_file" | sed '/^$/N;/^\n$/D' > "$TEMP_FILE"
    
    # Also remove specific overlay lines if they exist (even outside our section)
    sed -i '/dtoverlay=tft35a/d' "$TEMP_FILE"
    sed -i '/dtoverlay=waveshare35a/d' "$TEMP_FILE"
    
    # Remove SPI if it was only added for LCD
    if grep -q "^dtparam=spi=on$" "$TEMP_FILE" && ! grep -q "spidev\|spi0" "$TEMP_FILE"; then
        sed -i '/^dtparam=spi=on$/d' "$TEMP_FILE"
    fi
    
    # Replace original config with cleaned version
    mv "$TEMP_FILE" "$config_file"
    echo "? LCD configuration removed"
}

# Function to restore config from backup
restore_config_backup() {
    local backup_file="$1"
    local config_file="$2"
    
    if [ -f "$backup_file" ]; then
        echo "Restoring original configuration from backup..."
        cp "$backup_file" "$config_file"
        rm -f "$backup_file"
        echo "? Original configuration restored"
        return 0
    else
        echo "No backup file found at $backup_file"
        return 1
    fi
}

# Function to handle MHS-35 cleanup
cleanup_mhs35() {
    echo ""
    echo "MHS-35 LCD Driver Cleanup"
    echo "=========================="
    
    if [ -d "/home/pi/lcd_show" ]; then
        echo "MHS-35 driver found at /home/pi/lcd_show"
        echo ""
        echo "What would you like to do?"
        echo "1) Keep MHS-35 driver (for other uses)"
        echo "2) Switch back to HDMI output"
        echo "3) Remove MHS-35 driver completely"
        echo "4) Skip MHS-35 cleanup (default)"
        echo ""
        
        MHS_CHOICE="4"
        if [ -t 0 ]; then
            read -t 30 -p "Choice [1-4] (default: 4): " MHS_CHOICE || true
        fi
        
        case $MHS_CHOICE in
            1)
                echo "Keeping MHS-35 driver."
                ;;
            2)
                echo "Switching back to HDMI output..."
                cd /home/pi/lcd_show 2>/dev/null && ./LCD-hdmi 2>/dev/null || \
                echo "Could not switch to HDMI, you may need to do it manually"
                echo "You can run: cd /home/pi/lcd_show && ./LCD-hdmi"
                ;;
            3)
                echo "Removing MHS-35 driver..."
                # First switch back to HDMI if possible
                cd /home/pi/lcd_show 2>/dev/null && ./LCD-hdmi 2>/dev/null || true
                # Remove the directory
                rm -rf /home/pi/lcd_show 2>/dev/null || true
                echo "? MHS-35 driver removed"
                ;;
            4|"")
                echo "Skipping MHS-35 cleanup."
                ;;
            *)
                echo "Invalid choice. Skipping MHS-35 cleanup."
                ;;
        esac
    fi
}

# Determine config file location
if [ -f /boot/firmware/config.txt ]; then
    CONFIG_FILE="/boot/firmware/config.txt"
    BACKUP_FILE="/boot/firmware/config.txt.backup-audio-player"
elif [ -f /boot/config.txt ]; then
    CONFIG_FILE="/boot/config.txt"
    BACKUP_FILE="/boot/config.txt.backup-audio-player"
else
    CONFIG_FILE=""
    BACKUP_FILE=""
fi

# Interactive LCD cleanup during remove (not purge)
if [ "$1" = "remove" ] || [ "$1" = "upgrade" ]; then
    echo ""
    echo "========================================="
    echo "Audio Player Removal - LCD Configuration"
    echo "========================================="
    
    # Check for MHS-35 installation
    if [ -d "/home/pi/lcd_show" ] || [ -f "/usr/local/bin/mhs35-show" ]; then
        cleanup_mhs35
    fi
    
    if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then
        # Check for audio-player LCD configuration
        if grep -q "# 3.5\" LCD Configuration (auto-configured by audio-player)" "$CONFIG_FILE" || \
           grep -q "dtoverlay=tft35a\|dtoverlay=waveshare35a" "$CONFIG_FILE"; then
            
            echo ""
            echo "Traditional LCD Configuration"
            echo "=============================="
            echo "Audio-player LCD configuration detected."
            echo ""
            echo "What would you like to do with the LCD configuration?"
            echo "1) Keep LCD configuration (if you want to use LCD for other purposes)"
            echo "2) Remove only audio-player LCD configuration"
            echo "3) Restore original config from backup"
            echo "4) Skip LCD configuration changes (default)"
            echo ""
            
            # Try to read from stdin, fallback to default
            LCD_CHOICE="4"
            if [ -t 0 ]; then
                # We have a terminal, can read input
                read -t 30 -p "Choice [1-4] (default: 4): " LCD_CHOICE || true
            fi
            
            case $LCD_CHOICE in
                1)
                    echo "Keeping LCD configuration."
                    ;;
                2)
                    remove_lcd_config "$CONFIG_FILE"
                    echo "? LCD configuration removed"
                    echo ""
                    echo "Note: A reboot may be required for changes to take effect."
                    echo "You can reboot with: sudo reboot"
                    ;;
                3)
                    if restore_config_backup "$BACKUP_FILE" "$CONFIG_FILE"; then
                        echo "? Original configuration restored"
                        echo ""
                        echo "Note: A reboot may be required for changes to take effect."
                        echo "You can reboot with: sudo reboot"
                    fi
                    ;;
                4|"")
                    echo "Skipping LCD configuration changes."
                    ;;
                *)
                    echo "Invalid choice. Skipping LCD configuration changes."
                    ;;
            esac
        else
            echo "No audio-player LCD configuration found."
        fi
    fi
fi

# Data removal during purge
if [ "$1" = "purge" ]; then
    echo ""
    echo "========================================="
    echo "Purging Audio Player - Complete Cleanup"
    echo "========================================="
    
    # Handle MHS-35 cleanup during purge
    if [ -d "/home/pi/lcd_show" ] || [ -f "/usr/local/bin/mhs35-show" ]; then
        echo "MHS-35 LCD driver detected."
        echo "Would you like to switch back to HDMI? (y/N): "
        
        SWITCH_HDMI="n"
        if [ -t 0 ]; then
            read -t 30 -p "Switch to HDMI? (y/N): " SWITCH_HDMI || true
        fi
        
        if [ "$SWITCH_HDMI" = "y" ] || [ "$SWITCH_HDMI" = "Y" ]; then
            cd /home/pi/lcd_show 2>/dev/null && ./LCD-hdmi 2>/dev/null || \
            echo "Could not switch to HDMI automatically"
        fi
        
        echo "Would you like to remove the MHS-35 driver? (y/N): "
        REMOVE_MHS="n"
        if [ -t 0 ]; then
            read -t 30 -p "Remove MHS-35 driver? (y/N): " REMOVE_MHS || true
        fi
        
        if [ "$REMOVE_MHS" = "y" ] || [ "$REMOVE_MHS" = "Y" ]; then
            rm -rf /home/pi/lcd_show 2>/dev/null || true
            rm -f /usr/local/bin/mhs35-show 2>/dev/null || true
            echo "? MHS-35 driver removed"
        fi
    fi
    
    # Ask about traditional LCD configuration during purge
    if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then
        if grep -q "# 3.5\" LCD Configuration (auto-configured by audio-player)" "$CONFIG_FILE" || \
           grep -q "dtoverlay=tft35a\|dtoverlay=waveshare35a" "$CONFIG_FILE"; then
            
            echo "Traditional LCD configuration detected."
            echo "Would you like to remove the LCD configuration? (y/N): "
            
            REMOVE_LCD="n"
            if [ -t 0 ]; then
                read -t 30 -p "Remove LCD configuration? (y/N): " REMOVE_LCD || true
            fi
            
            if [ "$REMOVE_LCD" = "y" ] || [ "$REMOVE_LCD" = "Y" ]; then
                remove_lcd_config "$CONFIG_FILE"
                echo "? LCD configuration removed"
            else
                echo "Keeping LCD configuration."
            fi
        fi
    fi
    
    # Remove data and logs
    echo "Removing data files..."
    rm -rf /var/lib/audio-player 2>/dev/null || true
    rm -rf /var/log/audio-player 2>/dev/null || true
    
    # Remove backup files
    rm -f /boot/config.txt.backup-audio-player 2>/dev/null || true
    rm -f /boot/firmware/config.txt.backup-audio-player 2>/dev/null || true
    
    echo "? All configuration and data files removed"
fi

# Reload systemd
systemctl daemon-reload || true

exit 0
